# OpenLDAP

Check hostname

    hostname #check it’s fully qualified

Make sure host is in /etc/hosts

Check network ports 

    netstat -ltn 

We need port 389

    firewall-cmd —permanent —add-service=ldap
    firewall-cmd —reload

Install

    yum -y install openldap openldap-clients openldap-servers migrationtools

## Configure OpenLDAP

    cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG

    slaptest #will show errors but also creates dB in /var/lib/ldap

    chown ldap.ldap /var/lib/ldap/*

    systemctl start slapd
    systemctl enable slapd
    systemctl status slapd

    netstat -lt

    cd /etc/openldap/schema

    ldapadd -Y EXTERNAL -H ldapi:/// -D “cn=config” -f cosine.ldif

    ldapadd -Y EXTERNAL -H ldapi:/// -D “cn=config” -f nis.ldif

    cd

    slappasswd -s P@55word1 -n>rootpwd
    
    vi config.ldif

In the config file find the oldRootPW line to add the password, use esc-: r and rootpwd to set the password. Then

    ldapmodify -Y EXTERNAL -H ldapi:/// -f config.ldif

### Create directory structure

Use an example structure.ldif. Objects are separated by a clear line

    ldapadd -x -W -D “cn=Manager,dc=example,dc=com” -f structure.ldif

Search ldap with ldapsearch

### Create users and groups

    cat group.ldif

    ldapadd -x -W -D “cn=Manager,dc=example,dc=com” -f group.ldif

For users we can use the migration tools

    cd /usr/share/migrationtools
    vi migrate_common.ph

Change the MAIL_DOMAIN and DEFAULT_BASE

    cd -
    grep tux /etc/passwd > passwd
    /usr/share/migrationtools/migrate_passwd.pl passwd user.ldif
    vi user.ldif

Change user details

    ldapadd -x -W -D “cn=Manager,dc=example,dc=com” -f user.ldif

## Authenticate to LDAP

On a different server to the LDAP server:

* Add the LDAP Server to the /etc/hosts file
* Configure mkhomedir

    yum install openldap-clients nss-pam-ldapd

    authconfig-tui 

tui is a handy UI to configure LDAP for auth

Check the auth order:

    grep passwd /etc/nsswitch.conf

    getent passwd #can see ldap and local users

    getent group

## List users and groups

    grep ldap /etc/nsswitch.con
    
Edit etc/nsswitch.con to change use of LDAP info

Generally don’t configure the ldap server as an ldap client

## Search

    ldapsearch -x -H ldap://server1.example.com -b dc=example,dc=com

    ldapsearch -x -LLL -H ldap://server1.example.com -b dc=example,dc=com

    ldapsearch -x -H ldap://server1.example.com -b dc=example,dc=com “(object class=account)”

    ldapsearch -x -H ldap://server1.example.com -b dc=example,dc=com “(&(object class=account) (uid=fred))”

    ldapsearch -x -H ldap://server1.example.com -b dc=example,dc=com “(&(object class=account) (uid=fred))” uid uidNumber

Can drop -H if using auth ldap server

Generate a sample ldif file:

    ldapsearch -x -LLL -H ldap://server1.example.com -b dc=example,dc=com “(&(object class=account) (uid=fred))” > user.ldif

Then use ldapadd



