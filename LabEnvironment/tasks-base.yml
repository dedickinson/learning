---
- name: Make sure we have the packages we need
  yum: name={{ item }} state=present
  with_items:
    - openssh-server
    - epel-release
    - fail2ban
    - bash-completion

- name: Make sure we have a 'wheel' group
  group:
    name: wheel
    state: present

- name: Allow 'wheel' group to have passwordless sudo
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: '^%wheel'
    line: '%wheel ALL=(ALL) NOPASSWD: ALL'
    validate: 'visudo -cf %s'

- name: Make sure the ansible user exists
  user:
    name: ansible
    comment: "Ansible service account"
    state: present
    groups: wheel

- name: Set the ansible user's authorized key
  authorized_key:
    user: ansible
    state: present
    key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDcQRRFriF1j1IP3LmJ+GaceymxHdOoX/1nsQroDtnCHzTyhsr6ifHZNsbA9LIAXj/UVtrEUPfLfmLGC+PTDBeoIhuO4L6/ezVi+CGH5T1EuT9hQ23j4mP1St0E/CFVy44Z/Hb3KJ16wBpMZz7ki/6xc1NSAI5E3rInX+hYg3dnkOgXP92B+ighUmjy9IGtci+kAVtO0MsqEKgFqxNbFmSo+bV1VUL7gXlpJNYL22dvCrrJkeNINWXbAma3SEZt7lkI6JuM8/tYEaAOApqmlsN5t2/I2QEyXDRvbf2LpR3qR/cEpEQzMPdBCXFC+I1SgwPqLaQiXJEEJn5RilIsQfEr ansible@lab.local"

- name: fail2ban service
  service:
    name: fail2ban
    enabled: yes
    state: started
